<!-- Widget de chat para Masa Madre Monterrey - Versión no intrusiva -->
<div id="masa-madre-chatbot" style="position: fixed; bottom: 20px; right: 20px; z-index: 10000; font-family: 'Helvetica Neue', Arial, sans-serif;">
  <div id="chatbot-header" style="background-color: #8B4513; color: white; padding: 12px 15px; border-radius: 50px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.15);">
    <div style="display: flex; align-items: center;">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
        <path d="M20 2H4C2.9 2 2 2.9 2 4V16C2 17.1 2.9 18 4 18H9L12 21L15 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span>¿Necesitas ayuda?</span>
    </div>
    <div id="chatbot-status" style="width: 10px; height: 10px; background-color: #4CAF50; border-radius: 50%;"></div>
  </div>
  
  <div id="chatbot-body" style="display: none; background-color: white; border: 1px solid #ddd; border-radius: 12px; width: 350px; max-height: 500px; overflow: hidden; box-shadow: 0 2px 20px rgba(0,0,0,0.15); margin-top: 10px; flex-direction: column; display: flex;">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #8B4513; color: white; border-top-left-radius: 12px; border-top-right-radius: 12px;">
      <span>Asistente de Panadería</span>
      <button id="chatbot-close" style="background: none; border: none; color: white; font-size: 1.2em; cursor: pointer;">&times;</button>
    </div>
    
    <div id="chatbot-messages" style="flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; max-height: 350px;">
      <div class="message bot" style="background-color: #f1f1f1; color: #333; padding: 10px 15px; border-radius: 18px; max-width: 80%; margin-right: auto; border-bottom-left-radius: 4px;">
        ¡Hola! Soy tu asistente de panadería especializado en masa madre. ¿En qué puedo ayudarte hoy?
      </div>
    </div>
    
    <div style="padding: 10px; border-top: 1px solid #eee; display: flex; gap: 10px;">
      <input type="text" id="chatbot-input" placeholder="Escribe tu pregunta..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none;">
      <button id="chatbot-send" style="background-color: #8B4513; color: white; border: none; padding: 0 15px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
    
    <div id="chatbot-footer" style="padding: 10px; border-top: 1px solid #eee; display: none;">
      <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: #666;">
        <span>¿Te fue útil esta respuesta?</span>
        <div>
          <span class="feedback-btn" data-rating="5" style="cursor: pointer; margin-left: 8px;">👍</span>
          <span class="feedback-btn" data-rating="1" style="cursor: pointer; margin-left: 8px;">👎</span>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .message.user {
    background-color: #8B4513;
    color: white;
    padding: 10px 15px;
    border-radius: 18px;
    max-width: 80%;
    margin-left: auto;
    border-bottom-right-radius: 4px;
  }
  .message.bot {
    background-color: #f1f1f1;
    color: #333;
    padding: 10px 15px;
    border-radius: 18px;
    max-width: 80%;
    margin-right: auto;
    border-bottom-left-radius: 4px;
  }
  .product-suggestion {
    background-color: #fff9f9;
    border: 1px solid #ffe0e0;
    border-radius: 8px;
    padding: 10px;
    margin-top: 8px;
  }
  .product-title {
    font-weight: bold;
    color: #8B4513;
    margin-bottom: 5px;
  }
  .product-price {
    color: #555;
    font-size: 0.9em;
  }
  .loading-dots {
    display: inline-block;
    width: 40px;
  }
  .loading-dots span {
    height: 8px;
    width: 8px;
    background-color: #888;
    border-radius: 50%;
    display: inline-block;
    margin: 0 1px;
    animation: loading 1.4s infinite ease-in-out both;
  }
  .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
  .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
  @keyframes loading {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const chatbot = {
      header: document.getElementById('chatbot-header'),
      body: document.getElementById('chatbot-body'),
      messages: document.getElementById('chatbot-messages'),
      input: document.getElementById('chatbot-input'),
      sendButton: document.getElementById('chatbot-send'),
      footer: document.getElementById('chatbot-footer'),
      closeButton: document.getElementById('chatbot-close'),
      
      // Estado
      userId: null,
      isChatOpen: false,
      isProcessing: false,
      lastResponse: null,
      
      // Inicializar
      init: function() {
        this.loadUserId();
        this.checkAPIStatus();
        this.setupEventListeners();
        
        // Forzar que el chat esté cerrado al inicio
        this.body.style.display = 'none';
        this.isChatOpen = false;
      },
      
      // Configurar listeners
      setupEventListeners: function() {
        // Toggle chat al hacer clic en el header
        this.header.addEventListener('click', () => {
          if (!this.isChatOpen) {
            this.openChat();
          }
        });
        
        // Cerrar chat al hacer clic en el botón de cerrar
        this.closeButton.addEventListener('click', (e) => {
          e.stopPropagation();
          this.closeChat();
        });
        
        // Enviar mensaje
        this.sendButton.addEventListener('click', () => {
          this.sendMessage();
        });
        
        this.input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            this.sendMessage();
          }
        });
        
        // Feedback
        document.querySelectorAll('.feedback-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const rating = parseInt(e.target.getAttribute('data-rating'));
            this.submitFeedback(rating);
          });
        });
      },
      
      // Cargar o crear user ID
      loadUserId: function() {
        let userId = localStorage.getItem('masaMadreChatUserId');
        if (!userId) {
          userId = 'web_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
          localStorage.setItem('masaMadreChatUserId', userId);
        }
        this.userId = userId;
      },
      
      // Verificar estado de la API
      checkAPIStatus: function() {
        fetch('/api/health')
          .then(response => response.json())
          .then(data => {
            if (data.status === 'healthy') {
              document.getElementById('chatbot-status').style.backgroundColor = '#4CAF50';
            } else {
              document.getElementById('chatbot-status').style.backgroundColor = '#ff9800';
            }
          })
          .catch(() => {
            document.getElementById('chatbot-status').style.backgroundColor = '#f44336';
          });
      },
      
      // Abrir chat
      openChat: function() {
        this.body.style.display = 'flex';
        this.isChatOpen = true;
        
        // Inicializar sesión si es la primera vez
        if (!this.initialized) {
          this.initializeChatSession();
          this.initialized = true;
        }
      },
      
      // Cerrar chat
      closeChat: function() {
        this.body.style.display = 'none';
        this.isChatOpen = false;
      },
      
      // Inicializar sesión de chat
      initializeChatSession: function() {
        fetch('/api/chat/init', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ user_id: this.userId })
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            // Limpiar mensajes anteriores
            this.messages.innerHTML = '';
            this.addMessage(data.welcome_message, 'bot');
          } else {
            this.addMessage('Lo siento, estoy teniendo problemas para iniciar la sesión de chat. Por favor, inténtalo de nuevo más tarde.', 'bot');
          }
        })
        .catch(error => {
          console.error('Error initializing chat:', error);
          this.addMessage('No se pudo conectar con el servicio de chat. Por favor, inténtalo de nuevo más tarde.', 'bot');
        });
      },
      
      // Enviar mensaje
      sendMessage: function() {
        const message = this.input.value.trim();
        if (!message || this.isProcessing) return;
        
        // Mostrar mensaje del usuario
        this.addMessage(message, 'user');
        this.input.value = '';
        
        // Mostrar loading
        const loadingId = 'loading_' + Date.now();
        this.addLoadingIndicator(loadingId);
        
        this.isProcessing = true;
        
        // Enviar al backend
        fetch('/api/chat/message', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            user_id: this.userId,
            message: message
          })
        })
        .then(response => {
          // Remover loading
          this.removeElement(loadingId);
          
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          if (data.status === 'success') {
            // Guardar última respuesta para retroalimentación
            this.lastResponse = {
              query: message,
              response: data.response
            };
            
            // Mostrar respuesta
            this.addMessage(data.response, 'bot');
            
            // Mostrar fuentes si existen
            if (data.sources && data.sources.length > 0) {
              let sourcesHTML = '<div class="product-suggestion" style="margin-top: 8px; padding: 8px; border-radius: 8px; background-color: #f9f9f9;">';
              sourcesHTML += '<strong>Productos relacionados:</strong><br>';
              
              data.sources.slice(0, 2).forEach(source => {
                sourcesHTML += `<div class="product-title">${source.title}</div>`;
                sourcesHTML += `<div class="product-price">${source.price} - ${source.availability}</div>`;
                if (source.url) {
                  sourcesHTML += `<a href="${source.url}" target="_blank" style="color: #8B4513; text-decoration: none; font-size: 0.9em;">Ver producto</a>`;
                }
                sourcesHTML += '<br>';
              });
              
              sourcesHTML += '</div>';
              
              const sourcesDiv = document.createElement('div');
              sourcesDiv.className = 'message bot';
              sourcesDiv.innerHTML = sourcesHTML;
              this.messages.appendChild(sourcesDiv);
              this.scrollToBottom();
            }
            
            // Mostrar footer de retroalimentación
            this.footer.style.display = 'block';
          } else {
            this.addMessage('Lo siento, estoy teniendo problemas para procesar tu consulta. Por favor, inténtalo de nuevo más tarde.', 'bot');
          }
        })
        .catch(error => {
          console.error('Error sending message:', error);
          // Remover loading
          this.removeElement(loadingId);
          this.addMessage('Hubo un error al procesar tu mensaje. Por favor, inténtalo de nuevo.', 'bot');
        })
        .finally(() => {
          this.isProcessing = false;
        });
      },
      
      // Agregar mensaje
      addMessage: function(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        messageDiv.textContent = text;
        this.messages.appendChild(messageDiv);
        this.scrollToBottom();
      },
      
      // Agregar indicador de loading
      addLoadingIndicator: function(id) {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = id;
        loadingDiv.className = 'message bot';
        loadingDiv.style.opacity = '0.7';
        loadingDiv.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div> Procesando tu consulta...';
        this.messages.appendChild(loadingDiv);
        this.scrollToBottom();
      },
      
      // Remover elemento
      removeElement: function(id) {
        const element = document.getElementById(id);
        if (element) {
          element.remove();
        }
      },
      
      // Desplazar al fondo
      scrollToBottom: function() {
        this.messages.scrollTop = this.messages.scrollHeight;
      },
      
      // Enviar retroalimentación
      submitFeedback: function(rating) {
        if (!this.lastResponse) return;
        
        fetch('/api/chat/feedback', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            user_id: this.userId,
            rating: rating,
            comment: ''
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            this.addMessage('¡Gracias por tu retroalimentación!', 'bot');
            this.footer.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error submitting feedback:', error);
        });
      },
      
      // Solicitar soporte humano
      requestSupport: function(contactInfo) {
        fetch('/api/chat/support', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            user_id: this.userId,
            contact_info: contactInfo
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            this.addMessage('✅ Ticket de soporte creado. Un representante se contactará contigo pronto.', 'bot');
          }
        })
        .catch(error => {
          console.error('Error requesting support:', error);
          this.addMessage('Hubo un problema al crear tu ticket de soporte. Por favor, contacta directamente a soporte@masamadremonterrey.com', 'bot');
        });
      }
    };
    
    // Inicializar el chatbot
    chatbot.init();
  });
</script>
