<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba Chatbot Masa Madre</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #8B4513;
            text-align: center;
        }
        
        .instructions {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #8B4513;
        }
        
        .instructions h2 {
            color: #8B4513;
            margin-top: 0;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .test-content {
            margin: 30px 0;
            padding: 20px;
            background-color: #fff9f0;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Prueba del Chatbot Masa Madre</h1>
        
        <div class="instructions">
            <h2>Instrucciones de Prueba</h2>
            <ul>
                <li><strong>Verifica el estado</strong>: El punto verde/rojo/naranja indica si la API est√° conectada</li>
                <li><strong>Haz clic en el chatbot</strong>: Para abrir/cerrar la ventana de chat</li>
                <li><strong>Escribe preguntas</strong>: Prueba con temas de panader√≠a, masa madre, productos, etc.</li>
                <li><strong>Prueba soporte humano</strong>: Escribe "soporte", "agente" o "humano"</li>
                <li><strong>Da feedback</strong>: Usa üëç o üëé despu√©s de las respuestas</li>
                <li><strong>Verifica localStorage</strong>: Abre DevTools ‚Üí Application ‚Üí Local Storage</li>
            </ul>
        </div>
        
        <div class="test-content">
            <h3>Contenido de prueba</h3>
            <p>Esta es una p√°gina de prueba para el chatbot de Masa Madre. Puedes interactuar con el chatbot que aparece en la esquina inferior derecha.</p>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris.</p>
            <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
        </div>
    </div>

    <!-- CHATBOT WIDGET -->
    <div id="masa-madre-chatbot" style="position: fixed; bottom: 20px; right: 20px; z-index: 10000; font-family: 'Helvetica Neue', Arial, sans-serif;">
        <div id="chatbot-header" style="background-color: #8B4513; color: white; padding: 12px 15px; border-radius: 50px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.15);">
            <div style="display: flex; align-items: center;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                    <path d="M20 2H4C2.9 2 2 2.9 2 4V16C2 17.1 2.9 18 4 18H9L12 21L15 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>¬øNecesitas ayuda?</span>
            </div>
            <div id="chatbot-status" style="width: 10px; height: 10px; background-color: #e0e0e0; border-radius: 50%;"></div>
        </div>
        
        <div id="chatbot-body" style="display: none; background-color: white; border: 1px solid #ddd; border-radius: 12px; width: 350px; max-height: 500px; overflow: hidden; box-shadow: 0 2px 20px rgba(0,0,0,0.15); margin-top: 10px; flex-direction: column; display: flex;">
            <div id="chatbot-messages" style="flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; max-height: 350px;">
                <div class="message bot" style="background-color: #f1f1f1; color: #333; padding: 10px 15px; border-radius: 18px; max-width: 80%; margin-right: auto; border-bottom-left-radius: 4px;">
                    ¬°Hola! Soy tu asistente de panader√≠a especializado en masa madre. ¬øEn qu√© puedo ayudarte hoy?
                </div>
            </div>
            
            <div style="padding: 10px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                <input type="text" id="chatbot-input" placeholder="Escribe tu pregunta..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none;">
                <button id="chatbot-send" style="background-color: #8B4513; color: white; border: none; padding: 0 15px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            
            <div id="chatbot-footer" style="padding: 10px; border-top: 1px solid #eee; display: none;">
                <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: #666;">
                    <span>¬øTe fue √∫til esta respuesta?</span>
                    <div>
                        <span class="feedback-btn" data-rating="5" style="cursor: pointer; margin-left: 8px;">üëç</span>
                        <span class="feedback-btn" data-rating="1" style="cursor: pointer; margin-left: 8px;">üëé</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .message.user {
            background-color: #8B4513;
            color: white;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .message.bot {
            background-color: #f1f1f1;
            color: #333;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        .product-suggestion {
            background-color: #fff9f9;
            border: 1px solid #ffe0e0;
            border-radius: 8px;
            padding: 10px;
            margin-top: 8px;
        }
        .product-title {
            font-weight: bold;
            color: #8B4513;
            margin-bottom: 5px;
        }
        .product-price {
            color: #555;
            font-size: 0.9em;
        }
        .loading-dots {
            display: inline-block;
            width: 40px;
        }
        .loading-dots span {
            height: 8px;
            width: 8px;
            background-color: #888;
            border-radius: 50%;
            display: inline-block;
            margin: 0 1px;
            animation: loading 1.4s infinite ease-in-out both;
        }
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes loading {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>

    <script>
        // Reemplaza TODAS las ocurrencias de '/api/' con tu URL de Render
        const API_URL = 'https://masa-madre-chatbot-api.onrender.com/api'; // ¬°REEMPLAZA CON TU URL!

        document.addEventListener('DOMContentLoaded', function() {
            // Variables globales del chatbot
            let chatbot = {
                header: document.getElementById('chatbot-header'),
                body: document.getElementById('chatbot-body'),
                messages: document.getElementById('chatbot-messages'),
                input: document.getElementById('chatbot-input'),
                sendButton: document.getElementById('chatbot-send'),
                footer: document.getElementById('chatbot-footer'),
                feedbackButtons: document.querySelectorAll('.feedback-btn'),
                
                // Estado del chatbot
                userId: null,
                isChatOpen: localStorage.getItem('chatbotOpen') === 'true', // Carga estado guardado
                isProcessing: false,
                lastResponse: null,
                chatSessionInitialized: false,
                
                // Inicializa el chatbot
                init: function() {
                    this.loadUserId();
                    this.setupEventListeners();
                    this.checkApiStatus();
                    
                    // Asegurar que haya una sesi√≥n activa al abrir el chat
                    this.header.addEventListener('click', () => {
                        if (!this.userId) {
                            this.initializeChatSession();
                        }
                    });
                },
                
                // Carga o crea un ID de usuario √∫nico
                loadUserId: function() {
                    let userId = localStorage.getItem('masaMadreChatUserId');
                    if (!userId) {
                        userId = 'web_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                        localStorage.setItem('masaMadreChatUserId', userId);
                    }
                    this.userId = userId;
                },
                
                // Configura los listeners de eventos
                setupEventListeners: function() {
                    // Toggle para abrir/cerrar el chat
                    this.header.addEventListener('click', this.toggleChat.bind(this));
                    
                    // Enviar mensaje al hacer clic en el bot√≥n
                    this.sendButton.addEventListener('click', this.sendMessage.bind(this));
                    
                    // Enviar mensaje al presionar Enter
                    this.input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.sendMessage();
                        }
                    });
                    
                    // Configurar botones de retroalimentaci√≥n
                    document.querySelectorAll('.feedback-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const rating = parseInt(e.target.getAttribute('data-rating'));
                            this.submitFeedback(rating);
                        });
                    });
                },
                
                // Verifica el estado de la API
                checkApiStatus: function() {
                    fetch(`${API_URL}/health`)
                        .then(response => response.json())
                        .then(data => {
                            const statusDot = document.getElementById('chatbot-status');
                            if (data.status === 'healthy') {
                                statusDot.style.backgroundColor = '#4CAF50'; // Verde
                            } else {
                                statusDot.style.backgroundColor = '#ff9800'; // Naranja
                            }
                        })
                        .catch(error => {
                            console.error('Error checking API status:', error);
                            document.getElementById('chatbot-status').style.backgroundColor = '#f44336'; // Rojo
                        });
                },
                
                // Alterna la visibilidad del chat
                toggleChat: function() {
                    this.isChatOpen = !this.isChatOpen;
                    this.body.style.display = this.isChatOpen ? 'flex' : 'none';
                    // Guardar estado en localStorage
                    localStorage.setItem('chatbotOpen', this.isChatOpen);
                    
                    // Si el chat se abre y no hay sesi√≥n iniciada, iniciar una
                    if (this.isChatOpen && !this.chatSessionInitialized) {
                        this.initializeChatSession();
                    }
                },
                
                // Inicializa una sesi√≥n de chat
                initializeChatSession: function() {
                    fetch(`${API_URL}/init`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ user_id: this.userId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            this.chatSessionInitialized = true;
                            this.addMessage(data.welcome_message, 'bot');
                        } else {
                            this.addMessage('Lo siento, estoy teniendo problemas para iniciar la sesi√≥n de chat. Por favor, int√©ntalo de nuevo m√°s tarde.', 'bot');
                        }
                    })
                    .catch(error => {
                        console.error('Error initializing chat:', error);
                        this.addMessage('No se pudo conectar con el servicio de chat. Por favor, int√©ntalo de nuevo m√°s tarde.', 'bot');
                    });
                },
                
                // Env√≠a un mensaje al backend
                sendMessage: function() {
                    const message = this.input.value.trim();
                    if (!message || this.isProcessing) return;
                    
                    // Asegurarse de que haya un user_id v√°lido
                    if (!this.userId) {
                        this.initializeChatSession();
                        // Esperar un momento antes de enviar el mensaje
                        setTimeout(() => {
                            this.sendMessage();
                        }, 500);
                        return;
                    }
                    
                    // Mostrar mensaje del usuario
                    this.addMessage(message, 'user');
                    this.input.value = '';
                    
                    // Mostrar loading
                    const loadingId = 'loading_' + Date.now();
                    this.addLoadingIndicator(loadingId);
                    
                    this.isProcessing = true;
                    
                    // Enviar al backend
                    fetch(`${API_URL}/chat/message`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: this.userId,
                            message: message
                        })
                    })
                    .then(response => {
                        // Agregar log detallado para diagn√≥stico
                        console.log(`üì° Estado de respuesta: ${response.status}`);
                        if (!response.ok) {
                            return response.json().then(err => {
                                console.error('‚ùå Detalles del error:', err);
                                throw new Error(err.message || 'Network response was not ok');
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Eliminar indicador de carga
                        this.removeElement(loadingId);
                        
                        // Mostrar respuesta del bot
                        if (data.response) {
                            this.addMessage(data.response, 'bot');
                            this.lastResponse = data.response;
                            
                            // Mostrar sugerencias de productos si existen
                            if (data.sources && data.sources.length > 0) {
                                this.showProductSuggestions(data.sources);
                            }
                            
                            // Mostrar footer con feedback
                            this.footer.style.display = 'block';
                        } else {
                            this.addMessage('No recib√≠ una respuesta v√°lida del servidor.', 'bot');
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Error sending message:', error);
                        this.removeElement(loadingId);
                        this.addMessage('Hubo un error al procesar tu mensaje. Por favor, int√©ntalo de nuevo.', 'bot');
                    })
                    .finally(() => {
                        this.isProcessing = false;
                    });
                },
                
                // Muestra sugerencias de productos
                showProductSuggestions: function(sources) {
                    let sourcesHTML = '<div class="product-suggestion" style="margin-top: 8px; padding: 8px; border-radius: 8px; background-color: #f9f9f9;">';
                    sourcesHTML += '<strong>Productos relacionados:</strong><br>';
                    
                    // Mostrar m√°ximo 2 productos
                    sources.slice(0, 2).forEach(source => {
                        sourcesHTML += `<div class="product-title">${source.title}</div>`;
                        sourcesHTML += `<div class="product-price">${source.price} - ${source.availability}</div>`;
                        if (source.url) {
                            sourcesHTML += `<a href="${source.url}" target="_blank" style="color: #8B4513; text-decoration: none; font-size: 0.9em;">Ver producto</a>`;
                        }
                        sourcesHTML += '<br>';
                    });
                    
                    sourcesHTML += '</div>';
                    
                    const sourcesDiv = document.createElement('div');
                    sourcesDiv.className = 'message bot';
                    sourcesDiv.innerHTML = sourcesHTML;
                    this.messages.appendChild(sourcesDiv);
                    this.scrollToBottom();
                },
                
                // Agrega un mensaje al chat
                addMessage: function(text, sender) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${sender}`;
                    messageDiv.textContent = text;
                    this.messages.appendChild(messageDiv);
                    this.scrollToBottom();
                },
                
                // Agrega un indicador de carga
                addLoadingIndicator: function(id) {
                    const loadingDiv = document.createElement('div');
                    loadingDiv.id = id;
                    loadingDiv.className = 'message bot';
                    loadingDiv.style.opacity = '0.7';
                    loadingDiv.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div> Procesando tu consulta...';
                    this.messages.appendChild(loadingDiv);
                    this.scrollToBottom();
                },
                
                // Remueve un elemento del DOM
                removeElement: function(id) {
                    const element = document.getElementById(id);
                    if (element) {
                        element.remove();
                    }
                },
                
                // Desplaza el chat hacia abajo
                scrollToBottom: function() {
                    this.messages.scrollTop = this.messages.scrollHeight;
                },
                
                // Env√≠a retroalimentaci√≥n
                submitFeedback: function(rating) {
                    if (!this.lastResponse) return;
                    
                    fetch(`${API_URL}/feedback`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: this.userId,
                            rating: rating,
                            comment: ''
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            this.addMessage('¬°Gracias por tu retroalimentaci√≥n!', 'bot');
                            this.footer.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Error submitting feedback:', error);
                    });
                },
                
                // Solicita soporte humano
                requestSupport: function() {
                    this.addMessage("Por favor, proporciona tu informaci√≥n de contacto (correo o tel√©fono):", 'bot');
                    
                    // Configurar un listener temporal para la respuesta
                    const originalSend = this.sendMessage;
                    this.sendMessage = () => {
                        const contactInfo = this.input.value.trim();
                        if (contactInfo) {
                            this.input.value = '';
                            this.addMessage(`Informaci√≥n de contacto: ${contactInfo}`, 'user');
                            
                            // Enviar solicitud de soporte
                            fetch(`${API_URL}/support`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    user_id: this.userId,
                                    contact_info: contactInfo
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    this.addMessage('‚úÖ Ticket de soporte creado. Un representante se contactar√° contigo pronto.', 'bot');
                                } else {
                                    this.addMessage('Hubo un problema al crear tu ticket de soporte. Por favor, contacta directamente a soporte@masamadremonterrey.com', 'bot');
                                }
                            })
                            .catch(error => {
                                console.error('Error requesting support:', error);
                                this.addMessage('Hubo un problema al crear tu ticket de soporte. Por favor, contacta directamente a soporte@masamadremonterrey.com', 'bot');
                            });
                            
                            // Restaurar la funci√≥n original
                            this.sendMessage = originalSend;
                        }
                    };
                }
            };
            
            // Inicializar el chatbot
            chatbot.init();
            
            // Si el usuario escribe "soporte" o "agente", activar soporte humano
            document.getElementById('chatbot-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const message = this.value.trim().toLowerCase();
                    if (message.includes('soporte') || message.includes('agente') || message.includes('humano')) {
                        chatbot.requestSupport();
                        this.value = '';
                        e.preventDefault();
                    }
                }
            });
        });
    </script>
</body>
</html>
